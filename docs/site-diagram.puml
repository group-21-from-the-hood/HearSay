@startuml SiteDiagram
' Title
title HearSay â€” Site / Component Diagram

' =========================
' Actors & External Systems
' =========================
actor "End User (Browser)" as User
rectangle "Spotify Web API" as Spotify #DDDDFF
rectangle "Google OAuth\n(OpenID Connect)" as Google #FFDDDD
rectangle "Docker / Nginx\n(reverse proxy + static)" as NGINX #F3F3F3

' =========================
' Frontend
' =========================
package "Frontend (React - hearsay/src)" {
  component "App Router\nRoutes" as AppRouter
  component "Header / Nav" as Header
  component "LandingPage" as Landing
  component "SearchPage" as Search
  component "AlbumRatingPage" as AlbumPage
  component "SongRatingPage" as SongPage
  component "ArtistPage" as ArtistPage
  component "MyReviewsPage" as MyReviews
  component "RecentReviewsPage" as RecentReviews
  component "ProfilePage" as Profile
  component "RandomPage" as Random
  component "HeadphoneRating UI" as HeadphoneUI
  component "AuthPage / AuthCallback" as Auth
  component "ProtectedRoute" as ProtectedRoute
  component "Client API (calls /api/*)" as ClientApi
}

' Frontend relationships
User --> Header : interacts
User --> Landing
User --> Search
User --> AlbumPage
User --> SongPage
User --> ArtistPage
User --> MyReviews
User --> RecentReviews
User --> Profile
User --> Auth

Header --> ClientApi
AppRouter --> Landing
AppRouter --> Search
AppRouter --> AlbumPage
AppRouter --> SongPage
AppRouter --> ArtistPage
AppRouter --> MyReviews
AppRouter --> RecentReviews
AppRouter --> Profile
AppRouter --> Random

AlbumPage --> HeadphoneUI
SongPage --> HeadphoneUI
ArtistPage --> HeadphoneUI
MyReviews --> HeadphoneUI

AlbumPage --> ClientApi : /api/albums/:id\n/api/reviews/upsert\n/api/reviews/my
SongPage --> ClientApi : /api/spotify/track/:id\n/api/reviews/upsert\n/api/reviews/my
ArtistPage --> ClientApi : /api/spotify/artist/:id\n/api/reviews/upsert\n/api/reviews/my
MyReviews --> ClientApi : /api/reviews/my/list\n/api/reviews/my\n/api/reviews/upsert
RecentReviews --> ClientApi : /api/reviews/recent
Search --> ClientApi : /api/spotify/search
Random --> ClientApi : /api/spotify/new-releases\n/api/spotify/search

Auth --> ClientApi : /api/auth/google/exchange\n/api/me

' =========================
' Backend
' =========================
package "Backend (Express - server)" {
  component "API Proxy / Server" as Server
  component "Spotify Proxy\n(/api/spotify/*)" as SpotifyProxy
  component "Auth endpoints\n(/api/auth/*, /api/me)" as AuthEndpoints
  component "Reviews endpoints\n(/api/reviews/*)" as ReviewsApi
  component "Albums endpoints\n(/api/albums/:id)" as AlbumsApi
  component "Health / Debug endpoints" as Health
}

ClientApi --> NGINX : static + /api proxy
NGINX --> Server : proxy /api requests
Server --> SpotifyProxy : spotify requests (server-side token)
Server --> AuthEndpoints
Server --> ReviewsApi
Server --> AlbumsApi
Server --> Health

SpotifyProxy --> Spotify : server-side app auth + REST
AuthEndpoints --> Google : token exchange (via POST)
AuthEndpoints --> Server : session setup

' =========================
' Database
' =========================
package "MongoDB (DB)" as DB {
  database "Users" as Users
  database "Reviews" as Reviews
  database "Albums" as Albums
  database "Artists" as Artists
  database "Songs" as Songs
  database "Sessions" as Sessions
}

Server --> Users : user upsert / queries
ReviewsApi --> Reviews : create / update / delete / list
AlbumsApi --> Albums : get saved album metadata
Server --> Albums : ensure album docs and songs backfill
Server --> Artists : ensure artist docs
Server --> Songs : ensure song docs
Server --> Sessions : session store (connect-mongo)

' =========================
' Data flows / Notes
' =========================
note top of ReviewsApi
  - Reviews documents store:
    - user.oid, item.type, item.oid
    - rating (stored scaled x2 as Int32)
    - text
    - trackRatings (object) for album-level per-track ratings
  - /api/reviews/upsert accepts trackRatings for albums.
  - /api/reviews/my/list returns trackRatings for album reviews.
end note

note top of ClientApi
  - Frontend submits per-track ratings locally then:
    - validates all tracks rated -> computes album avg -> calls /api/reviews/upsert with trackRatings and album rating
  - My Reviews page shows one entry per album; Expand toggles trackRatings
end note

' =========================
' Deployment artifacts
' =========================
package "Deployment" {
  component "Docker Compose\n(backend, mongodb)" as Compose
  component "NGINX config" as NginxCfg
  component "Dockerfile (frontend / backend)" as Dockerfiles
}
NGINX --> NginxCfg
Compose --> Server
Compose --> DB
Dockerfiles --> NGINX

' =========================
' Directions & Legend
' =========================
legend right
  || Solid arrow || synchronous request / navigation
  || Rectangle || component / service
  || Database cylinder || persistent store
endlegend

@enduml
